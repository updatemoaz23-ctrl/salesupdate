<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>إدارة الأوردرات والعينات</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
      .hidden-item-group {
        display: none;
      }
    </style>
</head>
<body>
    <div class="container">
        <h2>إدخال أوردر أو عينة</h2>
        <form id="submissionForm">
            <div class="form-group">
                <label for="employee">اسم الموظف</label>
                <input type="text" id="employee" name="employee" required>
            </div>
            
            <div class="form-group">
                <label for="company">اسم الشركة</label>
                <input type="text" id="company" name="company">
            </div>

            <div class="form-group">
                <label for="responsiblePerson">الشخص المسئول</label>
                <input type="text" id="responsiblePerson" name="responsiblePerson">
            </div>
            
            <div class="form-group">
                <label for="phone">رقم التليفون</label>
                <input type="tel" id="phone" name="phone">
            </div>

            <div class="form-group">
                <label for="supplyOrderNumber">رقم أمر التوريد</label>
                <input type="text" id="supplyOrderNumber" name="supplyOrderNumber">
            </div>
            
            <div class="form-group">
                <label for="supplyDate">تاريخ التوريد</label>
                <input type="date" id="supplyDate" name="supplyDate">
            </div>

            <div class="form-group">
                <label for="deliveryLocation">مكان التسليم</label>
                <input type="text" id="deliveryLocation" name="deliveryLocation">
            </div>
            
            <div class="form-group">
                <label for="address">العنوان</label>
                <input type="text" id="address" name="address">
            </div>

            <h3>تفاصيل الأصناف</h3>
            <div id="itemsContainer">
                <div class="item-group">
                    <div class="form-group">
                        <label for="itemName0">اسم الصنف</label>
                        <input type="text" id="itemName0" name="itemName" class="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="batchId0">رقم الباتش</label>
                        <input type="text" id="batchId0" name="batchId" class="batchId">
                    </div>
                    <div class="form-group">
                        <label for="quantity0">الكمية</label>
                        <input type="text" id="quantity0" name="quantity" class="quantity" required>
                    </div>
                    <div class="form-group">
                        <label for="price0">السعر</label>
                        <input type="text" id="price0" name="price" class="price">
                    </div>
                </div>
            </div>
            
            <div class="add-item-btn-container">
                <button type="button" id="addItemBtn">إضافة صنف آخر</button>
            </div>
            
            <div class="form-group">
                <label for="notes">ملاحظات</label>
                <textarea id="notes" name="notes"></textarea>
            </div>

            <div class="button-group">
                <button type="submit" name="type" value="order">إرسال أوردر</button>
                <button type="submit" name="type" value="sample">إرسال عينة</button>
            </div>
        </form>
        <div id="responseMessage" class="response-message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let itemCounter = 1;
            const addItemBtn = document.getElementById('addItemBtn');
            const itemsContainer = document.getElementById('itemsContainer');
            const form = document.getElementById('submissionForm');
            const responseMessage = document.getElementById('responseMessage');
            
            addItemBtn.addEventListener('click', function() {
                const itemGroup = document.createElement('div');
                itemGroup.classList.add('item-group');
                itemGroup.innerHTML = `
                    <div class="form-group">
                        <label for="itemName${itemCounter}">اسم الصنف</label>
                        <input type="text" id="itemName${itemCounter}" name="itemName" class="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="batchId${itemCounter}">رقم الباتش</label>
                        <input type="text" id="batchId${itemCounter}" name="batchId" class="batchId">
                    </div>
                    <div class="form-group">
                        <label for="quantity${itemCounter}">الكمية</label>
                        <input type="text" id="quantity${itemCounter}" name="quantity" class="quantity" required>
                    </div>
                    <div class="form-group">
                        <label for="price${itemCounter}">السعر</label>
                        <input type="text" id="price${itemCounter}" name="price" class="price">
                    </div>
                    <button type="button" class="removeItemBtn">حذف الصنف</button>
                `;
                itemsContainer.appendChild(itemGroup);
                itemCounter++;
            });

            itemsContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('removeItemBtn')) {
                    event.target.parentElement.remove();
                }
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submittingButton = e.submitter;
                const submissionType = submittingButton.value;

                const items = [];
                const itemGroups = itemsContainer.querySelectorAll('.item-group');
                itemGroups.forEach(group => {
                    const itemName = group.querySelector('.itemName').value;
                    const batchId = group.querySelector('.batchId').value;
                    const quantity = group.querySelector('.quantity').value;
                    const price = group.querySelector('.price').value;
                    
                    if (itemName && quantity) {
                        items.push({
                            name: itemName,
                            batchId: batchId,
                            quantity: quantity,
                            price: price
                        });
                    }
                });

                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                data.type = submissionType;
                data.itemsData = JSON.stringify(items);
                
                // إضافة الحقول الجديدة هنا
                data.responsiblePerson = document.getElementById('responsiblePerson').value;
                data.supplyOrderNumber = document.getElementById('supplyOrderNumber').value;
                data.supplyDate = document.getElementById('supplyDate').value;
                data.deliveryLocation = document.getElementById('deliveryLocation').value;

                const url = 'https://script.google.com/macros/s/AKfycbxUtDxJW4TGwfVu2N3_hcUvz-sVd_Lp7T-aBgCAalXHU9gZwcfjzkWAsU8yopJcu-Qc/exec';
                const params = new URLSearchParams(data);

                fetch(url, {
                    method: 'POST',
                    body: params
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        responseMessage.textContent = 'تم تسجيل البيانات بنجاح!';
                        responseMessage.className = 'response-message success';
                        form.reset();
                    } else {
                        responseMessage.textContent = 'حدث خطأ: ' + result.message;
                        responseMessage.className = 'response-message error';
                    }
                    responseMessage.style.display = 'block';
                })
                .catch(error => {
                    responseMessage.textContent = 'حدث خطأ في الاتصال: ' + error.message;
                    responseMessage.className = 'response-message error';
                    responseMessage.style.display = 'block';
                });
            });
        });
    </script>
</body>
</html>